<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>豆瓣电影Top250</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <style>
      /* 原有样式保持不变 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: #f8f9fa;
        padding: 20px;
        margin: 0 auto;
        overflow-x: hidden;
      }

      .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .add-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .add-btn:hover {
        background-color: #218838;
      }

      .page-title {
        color: #333;
        margin: 0 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #0d6efd;
        font-weight: 600;
        padding-left: 10px;
      }

      .status-message {
        padding: 15px;
        border-radius: 6px;
        margin: 0 10px 20px;
        text-align: center;
      }
      .loading {
        background-color: #e3f2fd;
        color: #0d6efd;
        border: 1px solid #bbdefb;
      }
      .error {
        background-color: #f8d7da;
        color: #dc3545;
        border: 1px solid #f5c6cb;
      }

      .movies-container {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 15px;
        padding: 0 10px;
        margin-bottom: 30px; /* 给分页控件留出空间 */
      }

      .movie-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        min-width: 120px;
      }
      .movie-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      }

      .poster-container {
        position: relative;
        padding-top: 140%;
        height: 0;
        overflow: hidden;
      }
      .poster {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
      }
      .movie-card:hover .poster {
        transform: scale(1.05);
      }

      .collect-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 5vw;
        max-width: 36px;
        min-width: 24px;
        height: auto;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        padding: 2px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .movie-info {
        padding: 10px;
      }
      .movie-title {
        font-size: 1.2vw;
        min-font-size: 12px;
        max-font-size: 16px;
        margin: 0 0 8px 0;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .rating {
        color: #ff9800;
        font-weight: 500;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        font-size: 1vw;
      }
      .rating i {
        margin-right: 3px;
        font-size: 1em;
      }

      .tags {
        margin: 0 0 10px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .tag {
        background: #f1f3f5;
        color: #495057;
        font-size: 0.8vw;
        min-font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
      }

      .action-btns {
        display: flex;
      }
      .action-btns button {
        width: 100%;
        font-size: 0.9vw;
        padding: 6px 0;
        transition: background-color 0.3s ease;
      }
      .action-btns button:hover {
        background-color: #bb2d3b;
      }

      /* 分页控件样式 */
      .pagination-container {
        display: flex;
        justify-content: center;
        margin: 20px 0;
      }
      .pagination {
        margin: 0;
      }
      .pagination li {
        margin: 0 5px;
      }
      .pagination li a {
        cursor: pointer;
        padding: 8px 15px;
        border-radius: 4px;
        transition: all 0.2s ease;
      }
      .pagination li.active a {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
      }
      .pagination li.disabled a {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* 响应式调整 */
      @media (max-width: 1400px) {
        .movies-container {
          grid-template-columns: repeat(5, 1fr);
        }
      }
      @media (max-width: 1200px) {
        .movies-container {
          grid-template-columns: repeat(4, 1fr);
        }
      }
      @media (max-width: 992px) {
        .movies-container {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      @media (max-width: 768px) {
        .movies-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 576px) {
        .movies-container {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- 标题和操作按钮 -->
      <div class="header-actions">
        <h2 class="page-title">豆瓣电影Top250</h2>
        <button class="add-btn" onclick="window.location.href='add.html'">
          <i class="fa fa-plus"></i> 新增电影
        </button>
      </div>

      <!-- 加载状态 -->
      <div class="status-message loading" v-if="loading">
        <i class="fa fa-spinner fa-spin"></i> 加载中... 正在获取电影数据...
      </div>

      <!-- 错误提示 -->
      <div class="status-message error" v-if="error && !loading">
        <i class="fa fa-exclamation-circle"></i> {{ error }}
      </div>

      <!-- 电影列表 -->
      <div class="movies-container" v-else-if="movies.length > 0">
        <div class="movie-card" v-for="item of movies" :key="item._id"> 
          <div class="poster-container">
            <img
              class="poster"
              :src="item.pic"
              alt="电影海报"
              @error="item.pic = 'https://via.placeholder.com/300x450?text=无海报'"
              @click="handleToggle(item._id)"
            />
            <img
              class="collect-btn"
              @click="handleCollect(item._id)"
              :src="item.collected 
              ? 'https://cdn-icons-png.flaticon.com/128/1077/1077035.png' 
              : 'https://cdn-icons-png.flaticon.com/128/1077/1077032.png'"
              alt="收藏状态"
            />
          </div>

          <div class="movie-info">
            <h3 class="movie-title">{{ item.title }}</h3>
            <div class="rating">
              <i class="fa fa-star"></i>
              <span>{{ item.rating }}</span>
            </div>
            <div class="tags">
              <span class="tag" v-for="tag of item.labels" :key="tag"
                >{{ tag }}</span
              >
            </div>
            <div class="action-btns">
              <button
                @click="handleDelete(item._id)"
                type="button"
                class="btn btn-danger"
              >
                <i class="fa fa-trash-o"></i> 删除
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 空状态提示 -->
      <div class="status-message" v-else-if="!loading && !error">
        <i class="fa fa-film"></i> 暂无电影数据，快去添加吧~
      </div>

      <!-- 分页控件 -->
      <div class="pagination-container" v-if="total > 0 && !loading">
        <ul class="pagination">
          <!-- 上一页 -->
          <li :class="{ disabled: currentPage === 1 }">
            <a href="javascript:void(0)" @click="prevPage">
              <i class="fa fa-angle-left"></i> 上一页
            </a>
          </li>

          <!-- 页码按钮 -->
          <li
            v-for="page of pages"
            :key="page"
            :class="{ active: page === currentPage }"
          >
            <a href="javascript:void(0)" @click="doPage(page)">{{ page }}</a>
          </li>

          <!-- 下一页 -->
          <li :class="{ disabled: currentPage === totalPages }">
            <a href="javascript:void(0)" @click="nextPage">
              下一页 <i class="fa fa-angle-right"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <script>
      new Vue({
        el: "#app",
        data: {
          movies: [],
          loading: true,
          error: "",
          total: 0, // 总条数
          limit: 15, // 每页条数（与后端默认一致）
          currentPage: 1, // 当前页码
        },
        mounted() {
          this.loadMovies(0); // 初始加载第一页
        },
        computed: {
          // 计算总页数
          totalPages() {
            return Math.ceil(this.total / this.limit);
          },
          // 生成页码数组
          pages() {
            const arr = [];
            for (let i = 1; i <= this.totalPages; i++) {
              arr.push(i);
            }
            return arr;
          },
        },
        methods: {
          // 加载电影列表（带分页参数）
          async loadMovies(start = 0) {
            try {
              this.loading = true;
              // 发送带分页参数的请求
              const res = await axios.get(
                `http://localhost:8080/top250?start=${start}&limit=${this.limit}`
              );
              if (res.data.code === 200) {
                this.movies = res.data.res;
                this.total = res.data.total; // 更新总条数
                // 根据返回的start计算当前页码
                this.currentPage = Math.floor(res.data.start / this.limit) + 1;
              } else {
                this.error = res.data.msg;
              }
            } catch (err) {
              this.error =
                "加载失败：" + (err.response?.data?.msg || err.message);
            } finally {
              this.loading = false;
            }
          },

          // 点击页码切换页面
          doPage(page) {
            if (page < 1 || page > this.totalPages) return; // 边界校验
            const start = (page - 1) * this.limit; // 计算start值
            this.loadMovies(start);
          },

          // 新增：跳转到详情页
          handleToggle(id) {
            location.href = `detail.html?id=${id}`;
          },

          // 上一页
          prevPage() {
            if (this.currentPage > 1) {
              this.doPage(this.currentPage - 1);
            }
          },

          // 下一页
          nextPage() {
            if (this.currentPage < this.totalPages) {
              this.doPage(this.currentPage + 1);
            }
          },

          // 收藏/取消收藏
          async handleCollect(id) {
            const movie = this.movies.find((item) => item._id === id);
            if (!movie) return;
            const oldCollected = movie.collected;

            try {
              if (oldCollected) {
                await axios.post("http://localhost:8080/collect/cancel", {
                  id,
                });
                movie.collected = false;
              } else {
                await axios.post("http://localhost:8080/collect", { id });
                movie.collected = true;
              }
              this.movies = [...this.movies];
            } catch (err) {
              movie.collected = oldCollected;
              this.error =
                "操作失败：" + (err.response?.data?.msg || err.message);
              setTimeout(() => (this.error = ""), 3000);
            }
          },

          // 删除功能
          async handleDelete(id) {
            if (!confirm("确定要删除这部电影吗？删除后无法恢复！")) {
              return;
            }

            try {
              await axios.post("http://localhost:8080/delete", { id });
              // 删除后重新加载当前页
              this.loadMovies((this.currentPage - 1) * this.limit);
              this.error = "删除成功！";
              setTimeout(() => (this.error = ""), 2000);
            } catch (err) {
              this.error =
                "删除失败：" + (err.response?.data?.msg || err.message);
              setTimeout(() => (this.error = ""), 3000);
            }
          },
        },
      });
    </script>
  </body>
</html>
